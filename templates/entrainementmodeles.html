{% extends '_global.html' %}

{% block title %}<i class="bi bi-graph-up"></i> Modèle de classification{% endblock %}
{% block content %}
    <div class="content-card">
        <h4 class="mb-3 title-button">
            
            <button id="startTrainingBtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#trainingModal">
                <i class="bi bi-play-circle"></i> Démarrer un nouvel entraînement
            </button>
        </h4>

        <div class="row">
            <div class="col-md-6">
                {% if graphClass1 %}
                <img width="100%" src="data:image/png;base64,{{ graphClass1 }}" alt="Graphique">
                {% endif %}

                
            </div>
            <div class="col-md-6">
                {% if graphClass2 %}
                <img width="100%" src="data:image/png;base64,{{ graphClass2 }}" alt="Graphique">
                {% endif %}
            </div>
        </div>

        <div class="row margin">
            <div class="col-md-6">
                {% if graphClass3 %}
                <img width="100%" src="data:image/png;base64,{{ graphClass3 }}" alt="Graphique">
                {% endif %}

                
            </div>
            <div class="col-md-6">
                {% if graphClass4 %}
                <img width="100%" src="data:image/png;base64,{{ graphClass4 }}" alt="Graphique">
                {% endif %}
            </div>
        </div>

        <div class="row margin">
            <div class="col-md-6">
                {% if graphClass5 %}
                <img width="100%" src="data:image/png;base64,{{ graphClass5 }}" alt="Graphique">
                {% endif %}

                
            </div>
            <div class="col-md-6">
                {% if graphClass6 %}
                <img width="100%" src="data:image/png;base64,{{ graphClass6 }}" alt="Graphique">
                {% endif %}
            </div>
        </div>
    </div>


    <!-- Modale pour les paramètres d'entraînement -->
    <div class="modal fade" id="trainingModal" tabindex="-1" aria-labelledby="trainingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="trainingModalLabel">Paramètres d'entraînement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="trainingForm">
                        <!-- Nombre d'epochs -->
                        <div class="mb-3">
                            <label for="epochs" class="form-label">Nombre d'epochs</label>
                            <input type="number" class="form-control" id="epochs" name="epochs" value="5" min="1" required>
                        </div>

                        <!-- Sélection automatique de la meilleure epoch -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="autoSelectBest" name="autoSelectBest" checked>
                            <label class="form-check-label" for="autoSelectBest">
                                Sélection automatique de la meilleure epoch
                            </label>
                        </div>

                        <!-- Interruption automatique -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="earlyStop" name="earlyStop" checked>
                            <label class="form-check-label" for="earlyStop">
                                Interruption automatique (Early Stopping)
                            </label>
                        </div>

                        <!-- Patience -->
                        <div class="mb-3">
                            <label for="patience" class="form-label">Patience</label>
                            <input type="number" class="form-control" id="patience" name="patience" value="10" min="1" required>
                            <div class="form-text">Nombre d'epochs sans amélioration avant l'arrêt</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="startTraining()">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="trainingModalDoIt" tabindex="-1" aria-labelledby="trainingModalDoItLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="trainingModalDoItLabel">Entraînement du modèle de classification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label" id="statusMessage">Initialisation...</label>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                            role="progressbar" 
                                            id="progressBar" 
                                            style="width: 0%"
                                            aria-valuenow="0" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">0%</div>
                                    </div>
                                    <label class="form-label margin" id="statusMessage">Progression globale</label>
                                    <div class="progress " style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                            role="progressbarGlobal" 
                                            id="progressBarGlobal" 
                                            style="width: 0%"
                                            aria-valuenow="20" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">0%</div>
                                    </div>
                                </div>
                                
                                
                                <div class="row metric-card">
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2 text-muted">Epoch</h6>
                                                <h4 class="card-title" id="currentEpoch">-/-</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2 text-muted">Loss</h6>
                                                <h4 class="card-title" id="currentLoss">-</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2 text-muted">Accuracy</h6>
                                                <h4 class="card-title" id="currentAccuracy">-</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                

                                <div class="row margin">
                                    <div class="col-md-6">
                                        <div class="mb-3" id="result1ImageContainer" style="display: none;">
                                            <img id="result1Image" class="img-fluid" alt="Résultats de l'entraînement">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3" id="result2ImageContainer" style="display: none;">
                                            <img id="result2Image" class="img-fluid" alt="Résultats de l'entraînement">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>


    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let eventSource = null;

        function startTraining() {
            // Récupération des valeurs du formulaire
            const params = {
                epochs: document.getElementById('epochs').value,
                autoSelectBest: document.getElementById('autoSelectBest').checked,
                earlyStop: document.getElementById('earlyStop').checked,
                patience: document.getElementById('patience').value,
                sessionId: "A1"
            };

            console.log('Paramètres d\'entraînement:', params);

            // Fermer la modale
            const modal = bootstrap.Modal.getInstance(document.getElementById('trainingModal'));
            modal.hide();

            const modalTrain = new bootstrap.Modal(document.getElementById('trainingModalDoIt'));
            modalTrain.show();

            fetch('/entrainementmodeles/classification/train', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                listenToProgress("A1");
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Erreur lors du lancement de l\'entraînement');
            });
        }

        function listenToProgress(sessionId) {
            // Fermer la connexion SSE précédente si elle existe
            if (eventSource) {
                eventSource.close();
            }
            
            // Créer une nouvelle connexion SSE
            eventSource = new EventSource(`/entrainementmodeles/classification/train/${sessionId}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Update:', data);
                
                if (data.status === 'heartbeat') {
                    return; // Ignorer les heartbeats
                }
                
                updateUI(data);
                
                // Fermer la connexion si terminé ou erreur
                if (data.status === 'completed' || data.status === 'error' || data.status === 'early_stop') {
                    setTimeout(() => {
                        eventSource.close();
                        location.reload();
                    }, 3000);
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE Error:', error);
                eventSource.close();
                document.getElementById('startTrainingBtn').disabled = false;
            };
        }
        
        function updateUI(data) {
            // Mettre à jour le message de statut
            document.getElementById('statusMessage').textContent = data.message;
            
            // Mettre à jour la barre de progression
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
            progressBar.setAttribute('aria-valuenow', data.progress);

            // Changer la couleur selon le statut
            progressBar.className = 'progress-bar progress-bar-striped';
            if (data.status === 'completed' || data.status === 'early_stop') {
                progressBar.classList.add('bg-success');
            } else if (data.status === 'error') {
                progressBar.classList.add('bg-danger');
            } else {
                progressBar.classList.add('progress-bar-animated');
            }

            // Mettre à jour la barre de progression
            const progressBarGlobal = document.getElementById('progressBarGlobal');
            progressBarGlobal.style.width = data.progressGlobal + '%';
            progressBarGlobal.textContent = data.progressGlobal + '%';
            progressBarGlobal.setAttribute('aria-valuenow', data.progressGlobal);
            
            // Changer la couleur selon le statut
            progressBarGlobal.className = 'progress-bar progress-bar-striped';
            if (data.status === 'completed' || data.status === 'early_stop') {
                progressBarGlobal.classList.add('bg-success');
            } else if (data.status === 'error') {
                progressBarGlobal.classList.add('bg-danger');
            } else {
                progressBarGlobal.classList.add('progress-bar-animated');
            }
            
            
            // Mettre à jour les métriques
            if (data.epoch) {
                document.getElementById('currentEpoch').textContent = `${data.epoch}/${data.total_epochs}`;
            }
            if (data.loss !== undefined) {
                document.getElementById('currentLoss').textContent = data.loss;
            }
            if (data.accuracy !== undefined) {
                document.getElementById('currentAccuracy').textContent = data.accuracy;
            }

            // Afficher l'image si l' image est fournie
            if (data.imageResult1) {
                const imageContainer = document.getElementById('result1ImageContainer');
                const imageElement = document.getElementById('result1Image');
                
                imageElement.src = 'data:image/png;base64,' + data.imageResult1;
                imageContainer.style.display = 'block';
            }
            if (data.imageResult2) {
                const imageContainer = document.getElementById('result2ImageContainer');
                const imageElement = document.getElementById('result2Image');
                
                imageElement.src = 'data:image/png;base64,' + data.imageResult2;
                imageContainer.style.display = 'block';
            }
        }
    </script>

{% endblock %}