{% extends '_global.html' %}

{% block title %}<i class="bi bi-check-circle-fill"></i> Jeu de validation{% if score %} - résultats{% endif %}{% endblock %}


{% block content %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<div class="content-card">
<div class="mb-4">
    {% if score %}
    <button onclick="calculerScore()" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calculModal">
        <i class="bi bi-plus-circle"></i> Retour
    </button>
    {% else %}
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCommandModal">
        <i class="bi bi-plus-circle"></i> Ajouter une commande
    </button>
    
    <button onclick="calculerScore()" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calculModal">
        <i class="bi bi-plus-circle"></i> Calculer le score
    </button>
    {% endif %}
</div>

<!-- Tableau des commandes -->
<div class="table-responsive">
    <table class="table table-dark table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Commande</th>
                <th>Classe réelle</th>
                
                {% if score %}<th>Classe prédite</th>{% endif %}
                <th>Labels réels</th>
                {% if score %}<th>Labels prédits</th>{% endif %}
                {% if score %}<th>Score</th>{% endif %}
                {% if not score %}<th style="width: 150px;">Actions</th>{% endif %}
            </tr>
        </thead>
        <tbody id="commandsTableBody">
                {% for index, command in data.iterrows() %}
                <tr data-id="{{ command.id }}">
                    <td>{{ command.id }}</td>
                    <td>{{ command.command }}</td>
                    <td><span class="badge back-blue">{{ command.className }}</span></td>
                    {% if score %}
                    <td>
                        {% if command.className == command.classNamePredicted %}
                            <span class="badge back-green">{{ command.classNamePredicted }}</span>
                        {% else %}
                            <span class="badge back-red">{{ command.classNamePredicted }}</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td>
                        {% if command.labels is string %}
                        {% set data = command.labels | fromjson %}
                        {% for key, value in data.items() %}
                            <span class="badge back-blue me-1">{{ key }} : {{ value }}</span>
                        {% endfor %}
                        {% endif %}
                    </td>
                    {% if score %}
                    <td>
                        {% if command.labelsPredicted is string %}
                        {% set data = command.labelsPredicted | fromjson %}
                        {% for key, value in data.items() %}
                            {% if value.correct == 1 %}
                                <span class="badge back-green me-1">{{ key }} : {{ value.value }}</span>
                            {% else %}
                                <span class="badge back-red me-1">{{ key }} : {{ value.value }}</span>
                            {% endif %}
                            
                        {% endfor %}
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if score %}<td>{{ command.score }}</td>{% endif %}
                    {% if not score %}
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editCommand({{ command.id }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCommand({{ command.id }})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
           
        </tbody>
    </table>
</div>

<!-- Modal Ajout -->
<div class="modal fade" id="addCommandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle text-primary"></i> Ajouter une commande
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCommandForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addCommand" class="form-label">Commande *</label>
                        <input type="text" class="form-control" id="addCommand" name="command" required>
                    </div>
                    <div class="mb-3">
                        <label for="addClassName" class="form-label">Classe *</label>
                        <select class="form-select" id="addClassName" name="className" required>
                            <option value="">Sélectionnez une classe...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addLabels" class="form-label">Labels </label>
                        <textarea class="form-control" id="addLabels" name="labels" 
                        rows="3"
                        placeholder='Ex: "notation:3536"'></textarea>
                        <small class="form-text text-muted">Format label:valeur sur plusieurs lignes</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="calculModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <h5 class="mb-2">Calcul en cours...</h5>
                <p class="text-muted mb-0">Veuillez patienter</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modification -->
<div class="modal fade" id="editCommandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil text-warning"></i> Modifier la commande
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCommandForm">
                <input type="hidden" id="editCommandId" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editCommand" class="form-label">Commande *</label>
                        <input type="text" class="form-control" id="editCommand" name="command" required>
                    </div>
                    <div class="mb-3">
                        <label for="editClassName" class="form-label">Classe *</label>
                        <select class="form-select" id="editClassName" name="className" required>
                            <option value="">Sélectionnez une classe...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editLabels" class="form-label">Labels </label>
                        <textarea class="form-control" id="editLabels" name="labels" 
                        rows="3"
                        placeholder='Ex: "notation:3536"'></textarea>
                        <small class="form-text text-muted">Format label:valeur sur plusieurs lignes</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-save"></i> Mettre à jour
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast pour les notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Opération effectuée avec succès
        </div>
    </div>
</div>

</div>
<script>
// Variables globales
let addModal, calculModal, editModal, toast;
let availableClasses = [];

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les modales et le toast
    addModal = new bootstrap.Modal(document.getElementById('addCommandModal'));
    calculModal = new bootstrap.Modal(document.getElementById('calculModal'));
    editModal = new bootstrap.Modal(document.getElementById('editCommandModal'));
    toast = new bootstrap.Toast(document.getElementById('notificationToast'));
    
    // Charger les classes
    loadClasses();
    
    // Gestionnaire pour le formulaire d'ajout
    document.getElementById('addCommandForm').addEventListener('submit', handleAddCommand);
    
    // Gestionnaire pour le formulaire de modification
    document.getElementById('editCommandForm').addEventListener('submit', handleEditCommand);
});

//-------------------------------------------------------------------------------------------------
//Gestion des classes

// Charger les classes disponibles
function loadClasses() {
    return fetch('/validationset/classes')
        .then(response => response.json())
        .then(data => {
            availableClasses = data.classes;
            populateClassSelect('addClassName');
            populateClassSelect('editClassName');
        })
        .catch(error => {
            console.error('Erreur lors du chargement des classes:', error);
            showNotification('Erreur lors du chargement des classes', 'error');
        });
}

// Remplir une liste déroulante avec les classes
function populateClassSelect(selectId) {
    const select = document.getElementById(selectId);
    // Conserver la première option (placeholder)
    const firstOption = select.querySelector('option[value=""]');
    select.innerHTML = '';
    if (firstOption) {
        select.appendChild(firstOption);
    }
    
    availableClasses.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        select.appendChild(option);
    });
}

//-------------------------------------------------------------------------------------------------
//Notification

// Fonction pour afficher une notification
function showNotification(message, type = 'success') {
    const toastEl = document.getElementById('notificationToast');
    const toastIcon = toastEl.querySelector('.toast-header i');
    const toastMessage = document.getElementById('toastMessage');
    
    // Changer l'icône selon le type
    toastIcon.className = type === 'success' 
        ? 'bi bi-check-circle-fill text-success me-2' 
        : 'bi bi-exclamation-triangle-fill text-danger me-2';
    
    toastMessage.textContent = message;
    toast.show();
}


//-------------------------------------------------------------------------------------------------
//Ajout

// Ajout d'une commande
function handleAddCommand(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    //Transformation labels en JSON
    data.labels = textToJSON(data.labels)
    
    fetch('/validationset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Commande ajoutée avec succès');
            addModal.hide();
            document.getElementById('addCommandForm').reset();
            // Recharger la page pour afficher la nouvelle commande
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Erreur lors de l\'ajout', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur de communication avec le serveur', 'error');
    });
}


//-------------------------------------------------------------------------------------------------
//Edition

// Charger les données pour modification
function editCommand(id) {
    fetch(`/validationset/${id}`)
        .then(response => response.json())
        .then(command => {
            console.log(command);
            document.getElementById('editCommandId').value = command.id;
            document.getElementById('editCommand').value = command.command;
            document.getElementById('editClassName').value = command.className;
            document.getElementById('editLabels').value = jsonToText(JSON.parse(command.labels));

            editModal.show();
        })
        .catch(error => {
            console.error('Erreur:', error);
            showNotification('Erreur lors du chargement des données', 'error');
        });
}

// Modification d'une commande
function handleEditCommand(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    //Transformation labels en JSON
    data.labels = textToJSON(data.labels)

    const id = document.getElementById('editCommandId').value;
    
    fetch(`/validationset/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Commande mise à jour avec succès');
            editModal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Erreur lors de la modification', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur de communication avec le serveur', 'error');
    });
}


//-------------------------------------------------------------------------------------------------
//Suppression

// Suppression d'une commande
function deleteCommand(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette commande ?')) {
        fetch(`/validationset/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification('Commande supprimée avec succès');
                // Supprimer la ligne du tableau
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) {
                    row.remove();
                }
                
                // Vérifier si le tableau est vide
                const tbody = document.getElementById('commandsTableBody');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucune commande enregistrée</td></tr>';
                }
            } else {
                showNotification('Erreur lors de la suppression', 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showNotification('Erreur de communication avec le serveur', 'error');
        });
    }
}

function calculerScore(){
    window.location.href = window.location.pathname + '?score=1';
}



</script>


{% endblock %}